trigger:
  branches:
    include:
      - main
      
pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: BuildAndDeploy
  displayName: 'Build and Deploy'
  jobs:
    - job: DockerBuildAndDeploy
      displayName: 'Docker Build and Deploy'
      steps:
        - script: echo 'Starting Docker Build and Compose'
          displayName: 'Starting Docker Build and Compose'

        - task: Docker@2
          displayName: 'Build Docker Image'
          inputs:
            command: 'build'
            Dockerfile: '**/Dockerfile'
            tags: 'latest'

        - task: Docker@2
          displayName: 'Push Docker Image to Registry'
          inputs:
            command: 'push'
            tags: 'latest'
            containerRegistry: 'practicaVS'

        - task: Docker@2
          displayName: 'Docker Compose Up'
          inputs:
            command: 'composeUp'
            dockerComposeFile: '**/docker-compose.yml'
            removeContainersOnPull: true
            detachedService: true

- stage: SecurityScan
  displayName: 'Security Scan with SonarQube'
  jobs:
    - job: SonarQubeScan
      displayName: 'SonarQube Scan'
      steps:
        - task: SonarQubePrepare@4
          inputs:
            SonarQube: 'ServicioSonarQube'
            scannerMode: 'CLI'
            extraProperties: |
              sonar.sources=.
              sonar.host.url=https://tu-url-SonarQube
              sonar.login=token

        - task: SonarQubeAnalyze@4

        - task: SonarQubePublish@4
          inputs:
            pollingTimeoutSec: '300'
